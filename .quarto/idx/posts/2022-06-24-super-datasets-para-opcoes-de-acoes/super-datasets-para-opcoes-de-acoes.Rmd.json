{"title":"Super Datasets para Opções de Ações","markdown":{"yaml":{"title":"Super Datasets para Opções de Ações","description":"Um dos super datasets do pacote {rb3} é o de opções de ações.\nCom este dataset é possível realizar diversos cálculos com dados de opções de ações, como\ncalcular a volatilidade implícita das opções, as gregas e até mesmo fazer o ajuste de\nmodelos teóricos.\n","author":[{"name":"Wilson Freitas","url":{}}],"date":"2022-06-24"},"containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n```\n\nDados de opções de ações finalmente disponíveis de forma simples e direta.\nDurante muito tempo busquei isso, os dados de opções são mais chatos pois precisam de outros dados\npara a realização dos cálculos.\nTer apenas os dados de prêmio das opções (preços das opções) não permite que diversas das medidas\nde interesse associadas a opções, como as gregas e a volatilidade implícita, sejam calculadas.\nUtilizando Black & Scholes é necessário ainda ter o preço do ativo objeto (preço da ação) e as\ntaxas de juros.\nCom estas informações é possível calcular a volatilidade e a partir daí todas as demais medidas\nde interesse podem ser calculadas.\n\nVou mostrar aqui como calcular a volatilidade e as gregas para opções a partir de dados obtidos \ncom o pacote {rb3}.\nPara realizar os cálculos com as opções eu utilizo o pacote {oplib} que desenvolvi com diversos\nmodelos implementados:\n\n- Black, Scholes & Merto para apreçamento das opções\n- Black para apreçamento de opções sobre futuros, utilizado em opções sobre índices de taxas de juros, como IDI\n- Corrado-Su para o apreçamento de opções considerando assimetria e curtose\n- entre outros\n\nEste pacote ainda é experimental, não está publicado no CRAN e a documentação ainda está em desenvolvimento.\n\nVamos começar carregando os pacotes\n\n```{r}\nlibrary(rb3)\nlibrary(bizdays)\nlibrary(tidyverse)\nlibrary(oplib)\n```\n\nVamos selecionar o último dia útil para obter os dados diários do arquivo COTAHIST disponibilizado pela B3.\nO arquivo COTAHIST traz diversas informações do mercado de ações e inclui as opções.\nAdicionalmente, precisamos das taxas de juros e utilizo a função `rb3::yc_get` para obter a curva de juros\npara a data de referência.\n\n```{r}\nrefdate <- preceding(\"2022-06-24\", \"Brazil/ANBIMA\")\nch <- cotahist_get(refdate, \"daily\")\nyc <- yc_get(refdate)\n```\n\nCom os dados de ações e opções, pelo arquivo COTAHIST, e com as taxas de juros, utilizo a função\n`rb3::cotahist_options_by_symbol_superset` para obter os dados de opções para um símbolo específico.\nAqui vou utilizar `PETR4` que é uma das ações com maior volume de negociação na bolsa.\n\n```{r}\nsymbol_ <- \"PETR4\"\nop1 <- cotahist_options_by_symbol_superset(symbol_, ch, yc)\n```\n\nNo data.frame `op1` temos informações de preço da ação na data de referência, preços das opções,\ntaxas de juros, vencimento das opções, volumes de negociação e diversas outras informações.\n\n```{r}\nop1\n```\n\npara simplificar os cálculos vou separar duas informações úteis, os vencimentos das opções e o\npreço de fechamento da ação, que é único para a data de referência.\nOs vencimentos das opções são ordenados para que eu possa facilmente selecionar um vencimento\ndesejado.\n\n```{r}\nmaturities <- unique(op1$maturity_date) |> sort()\nclose_underlying <- op1$close.underlying[1]\n```\n\nAs opções de ações, tipicamente, possuem maior liquidez no primeiro vencimento disponível.\nPor isso, vou selecionar todas as opções com `maturity_date == maturities[1]`.\n\n```{r}\nop_vol <- op1 |>\n  filter(maturity_date == maturities[1]) |>\n  mutate(\n    biz_days = bizdays(\n      refdate, following(maturity_date, \"Brazil/ANBIMA\"), \"Brazil/ANBIMA\"\n    ),\n    time_to_maturity = biz_days / 252,\n    rate = log(1 + r_252),\n    impvol = bsmimpvol(\n      close, type, close.underlying, strike, time_to_maturity, rate, 0\n    ),\n    delta = bsmdelta(\n      type, close.underlying, strike, time_to_maturity, rate, 0, impvol\n    )\n  ) |>\n  select(\n    symbol, volume,\n    type, close.underlying, strike, time_to_maturity, rate, impvol,\n    delta, biz_days, volume\n  )\n```\n\nApós a seleção das opções, uma série de cálculos são realizados para obter:\n\n- dias úteis até o vencimento `biz_days`\n- prazo em anos até o vencimento `time_to_maturity`\n- taxas de juros em capitalização contínua `rate`\n- volatilidade implícita `impvol` com o modelo Black & Scholes\n- a grega `delta` para o modelo Black & Scholes\n\nEm seguida algumas variáveis são selecionadas para a visualizção dos dados.\n\nVamos visualizar o *smile* de volatilidade para com os preços de exercício das opções no eixo X\nColoco uma linha vertical marcando o nível do preço do ativo objeto, facilitando a interpretação do\nque está dentro/fora do dinheiro para as opções de compra e venda (Calls e Puts).\nO tamanho de cada ponto é definido pelo volumen de negociação de cada opção.\nInteressante notar que os maiores volumes ficam nos strikes próximos do preço atual do ativo objeto.\nEstas são as opções ATM, no dinheiro.\n\n```{r strike-vol, preview=TRUE}\nop_vol |>\n  filter(!is.na(impvol)) |>\n  ggplot(aes(x = strike, y = impvol, colour = type, size = volume)) +\n  geom_point() +\n  geom_vline(xintercept = close_underlying, alpha = 0.5, size = 1) +\n  facet_wrap(type ~ biz_days) +\n  theme(legend.position = \"bottom\") +\n  labs(\n    x = \"Strike\", y = \"Implied Volatility\",\n    title = str_glue(\"Equity Options Volatility - {symbol_} {format(refdate)}\")\n  )\n```\n\nAbaixo temos o *smile* de volatilidade com o delta das opções no eixo X.\nAqui fica mais fácil visualizar as opções ATM, pois estas tem delta de 0.5 (ou -0.5 no caso das Puts).\n\n```{r delta-vol}\nop_vol |>\n  filter(!is.na(impvol)) |>\n  ggplot(aes(x = delta, y = impvol, colour = type, size = volume)) +\n  geom_point() +\n  geom_vline(xintercept = c(-0.5, 0.5), alpha = 0.5, size = 1) +\n  facet_wrap(~ biz_days, scales = \"free\") +\n  theme(legend.position = \"bottom\") +\n  labs(\n    x = \"Delta\", y = \"Implied Volatility\",\n    title = str_glue(\"Equity Options Volatility - {symbol_} {format(refdate)}\")\n  )\n```\n\nO objetivo deste post é mostrar como é fácil obter dados de opções com o pacote {rb3} e com o pacote\n{oplib} realizar os cálculos com estes dados.\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"super-datasets-para-opcoes-de-acoes.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.335","theme":"litera","title-block-banner":true,"title":"Super Datasets para Opções de Ações","description":"Um dos super datasets do pacote {rb3} é o de opções de ações.\nCom este dataset é possível realizar diversos cálculos com dados de opções de ações, como\ncalcular a volatilidade implícita das opções, as gregas e até mesmo fazer o ajuste de\nmodelos teóricos.\n","author":[{"name":"Wilson Freitas","url":{}}],"date":"2022-06-24"},"extensions":{"book":{"multiFile":true}}}}}