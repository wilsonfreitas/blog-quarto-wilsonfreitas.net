{"title":"Dinâmica da Volatilidade Implícita","markdown":{"yaml":{"title":"Dinâmica da Volatilidade Implícita","description":"Como a volatilidade implícita das opções evolui no tempo? Há diversas formas de se avaliar isso.\nAqui veremos como é a dinâmica na volatilidade das opções ATM no tempo.\n","author":[{"name":"Wilson Freitas","url":{}}],"date":"2022-08-29"},"headingText":"Dinâmica da Volatilidade ATM","containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n```\n\nHá divesos estudos sobre o comportamento das opções e sobre quais fatores são mais importantes\npara explicar as suas mudanças de preços.\nSabemos que, depois do ativo objeto, a volatilidade implícita é a variável que mais influiencia nas\nvariações de preços das opções.\nDessa forma, é importante entender como se dão as suas variações, de outra forma, é importante\nconhecer a sua dinâmica.\n\nAqui vou carregar o histórico de opções de PETR4 desde o começo de 2022, calcular a volatilidade\nimplícita e o delta para cada uma das opções, e para cada data de referência, selecionar as\nopções, call e put, mais próximas da data de vencimento e com o delta mais próximo de 50%.\n\nAssim teremos uma opção, para cada tipo, call e put, em cada data de referência.\nDessa maneira, é possível construir uma série temporal de volatilidade implícita por tipo de opção.\n\nAs opções mais próximas do vencimento (ou primeiro vencimento), apresentam a maior liquidez dentre\nas opções negociadas.\nAqui estamos selecionando o primeiro vencimento até a sua expiração, entretanto, é interessante que\nseja realizada uma análise da liquidez das opções a medida que se aproximam do vencimento para que\numa estratégia de rolagem seja definida.\nPois, na medida que o primeiro vencimento se aproxima, a liquidez migra para o segundo vencimento.\nO desafio é identificar a dinâmica dessa migração.\nAqui isso não será levado em consideração, vamos carregar as opções do primeiro vencimento até a sua\nexpiração.\n\nComeçando com o carregamento de pacotes.\n\n```{r load-packages, message=FALSE, warning=FALSE}\nlibrary(rb3)\nlibrary(oplib)\nlibrary(bizdays)\nlibrary(tidyverse)\n```\n\nAs opções são carregadas via o arquivo COTAHIST (`rb3::cotahist_get`) e as curvas de juro são baixadas\ndo site da B3 na página de Taxas de Referência (`rb3::yc_mget`).\n\n```{r data, cache=TRUE, message=FALSE, warning=FALSE}\nrefdate <- getdate(\"last bizday\", Sys.Date(), \"Brazil/B3\")\nch <- cotahist_get(refdate, \"yearly\")\nyc <- yc_mget(first_date = as.Date(\"2022-01-01\"), last_date = refdate)\n```\n\nVamos utilizar a função `rb3::cotahist_options_by_symbol_superset` para obter o super dataset\npara opções de PETR4.\nDe posse do super dataset, os dados de vencimento e taxas de juros são formatados para o cálculo\nda volatilidade implícita e do delta para todas as opções.\n\n```{r symbol-data, cache=TRUE}\nsymbol <- \"PETR4\"\n\nop <- cotahist_options_by_symbol_superset(symbol, ch, yc)\n\nop_vol <- op |>\n  mutate(\n    biz_days = bizdays(\n      refdate, following(maturity_date, \"Brazil/B3\"), \"Brazil/B3\"\n    ),\n    time_to_maturity = biz_days / 252,\n    rate = log(1 + r_252),\n    bsm_impvol = bsmimpvol(\n      close, type, close.underlying, strike, time_to_maturity, rate, 0\n    ),\n    delta = bsmdelta(\n      type, close.underlying, strike, time_to_maturity, rate, 0, bsm_impvol\n    )\n  ) |>\n  select(\n    refdate, symbol, volume, maturity_date,\n    type, close.underlying, strike, time_to_maturity, rate,\n    biz_days, close, high, low, bsm_impvol, delta\n  )\n```\n\n\nComo todos os cálculos realizados vamos selecionar as opções ATM do primeiro\nvencimento para cada data de referência.\nFazemos uma segmentação dos dados por `refdate` e para cada *chunk* selecionamos o primeiro vencimento.\n\n```{r}\nop1 <- op_vol |>\n  split(op_vol$refdate) |>\n  map_dfr(function(df) {\n    first_mat <- df$maturity_date[which.min(df$maturity_date)]\n    filter(df, maturity_date == first_mat)\n  })\n```\n\nO dataframe `op1` tem opções call e put, em diversos strikes, para cada data de referência.\nAgora precisamos selecionar as opções mais próximas do dinheiro, ou seja, as opções com delta\nmais próximo de 50%.\nComo há uma diferença de sinal entre opções call e put, vamos calcular as diferenças em valores\nabsolutos do delta em relação ao valor 0.5 (delta = 50%).\n\n```{r}\nop1_atm <- split(op1, op1$refdate) |>\n  map_dfr(function(df) {\n    df_type <- filter(df, type == \"Put\")\n    df1 <- df_type[which.min(abs(abs(df_type$delta) - 0.5)), ]\n\n    df_type <- filter(df, type == \"Call\")\n    df2 <- df_type[which.min(abs(abs(df_type$delta) - 0.5)), ]\n\n    bind_rows(df1, df2)\n  })\n```\n\nO dataframe `op1_atm` tem, para cada data de referência, 1 call ATM e 1 put ATM.\n\nVamos visualizar a série temporal de volatilidades implícitas para estas opções.\n\n```{r op1-vol-atm, preview=TRUE}\nop1_atm |>\n  ggplot(aes(x = refdate, y = bsm_impvol, colour = type)) +\n  geom_line() +\n  geom_point() +\n  facet_wrap(type ~ .) +\n  labs(\n    x = \"Data\", y = \"Volatilidade Implícita\",\n    title = \"Série Histórica Volatilidade Implícita (ATM) - PETR4\",\n    subtitle = \"Volatilidade implícita de opções com delta mais próximo de 50%\",\n    caption = \"Desenvolvido por wilsonfreitas / Fonte: B3\"\n  ) +\n  theme(legend.position = \"none\")\n```\n\nÉ possível notar que a dinâmica da volatilidade, entre as opções call e put, é bem comportada.\nHá eventuais momentos de divergência, contudo, o comportamento das duas séries é bastante semelhante.\nAs séries apresentam um forte comportamento de reversão à média, o que é característico desse tipo\nde variável.\n\nOutro ponto interessante é verificar quais os preços de exercício para as opções ATM selecionadas.\nPois, uma vez que o preço do ativo objeto muda, o delta da opção muda e o preço de exercício que\nrepresenta o delta também muda.\n\n```{r}\nop1_atm |>\n  ggplot(aes(x = refdate, y = strike, colour = type)) +\n  geom_line() +\n  geom_point(aes(shape = type), size = 3) +\n  labs(\n    x = \"Data\", y = \"Strike\",\n    title = \"Série Histórica Strikes (ATM) - PETR4\",\n    subtitle = \"Preços de exercício de opções com delta mais próximo de 50%\",\n    caption = \"Desenvolvido por wilsonfreitas / Fonte: B3\"\n  ) +\n  theme(legend.position = \"top\", legend.title = element_blank())\n```\n\nAqui as séries são praticamente as mesmas, indicando que as opções ATM, calls e puts, possuem os\nmesmos strikes.\nEm poucos pontos há uma diferença nos preços de exercício.\nÉ interessante que este ponto seja melhor avaliado e talvez a liquidez das opções ajude a explicar\nestas diferenças.\n\nVamos observar os deltas das opções ATM selecionadas.\nUma vez que estamos selecionando opções ATM, é interessante que os deltas estejam próximos de 50%.\nMas como se dá essa seleção?\nNo gráfico abaixo vemos que os deltas de calls e puts oscilam em torno de 50% e estão sempre próximos\nentre si, há poquíssimos casos em que o delta da call está acima de 50% e o delta da put está abaixo\nde 50%.\nNovamente, cabe uma melhor investigação para melhor compreender os fatores causadores da divergência.\n\n```{r}\nop1_atm |>\n  mutate(delta = ifelse(delta < 0, 1 + delta, delta)) |>\n  ggplot(aes(x = refdate, y = delta, colour = type)) +\n  geom_line() +\n  geom_point() +\n  labs(\n    x = \"Data\", y = \"Delta\",\n    title = \"Série Histórica Deltas (ATM) - PETR4\",\n    subtitle = \"Delta de opções com delta mais próximo de 50%\",\n    caption = \"Desenvolvido por wilsonfreitas / Fonte: B3\"\n  ) +\n  theme(legend.position = \"top\", legend.title = element_blank())\n```\n\nUma vez que construímos as séries temporais para a volatilidade de opções ATM, o próximo passo\né modelar essa série.\nUm problema interessante é comparar essa dinâmica com a volatilidade realizada, talvez separando por\ncada vencimento.\nIdealmente a volatilidade implícita deveria convergir para a volatilidade realizada.\nOutro ponto que ficou em aberto e a avaliação da liquidez e sua consequência na estratégia de rolagem.\nAqui estamos selecionando as opções mais próximas do ATM para obter as volatilidades.\nUma alternativa é fazer o ajuste de um modelo e obter a volatilidade teórica par um delta de 50%.\nEm geral, como a liquidez se concentra próximo à vizinhança das opções no dinheiro, há bastante\ninformação nessa região para obter um bom modelo ajustado."},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"dinamica-da-volatilidade-implicita.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.335","theme":"litera","title-block-banner":true,"title":"Dinâmica da Volatilidade Implícita","description":"Como a volatilidade implícita das opções evolui no tempo? Há diversas formas de se avaliar isso.\nAqui veremos como é a dinâmica na volatilidade das opções ATM no tempo.\n","author":[{"name":"Wilson Freitas","url":{}}],"date":"2022-08-29"},"extensions":{"book":{"multiFile":true}}}}}