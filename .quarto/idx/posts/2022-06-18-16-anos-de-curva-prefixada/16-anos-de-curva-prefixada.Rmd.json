{"title":"16 anos de Curva Prefixada","markdown":{"yaml":{"title":"16 anos de Curva Prefixada","description":"Observando a dinâmica da estrutura a termo de juros no Brasil e nos Estados\nUnidos ao longo dos últimos 16 anos.\n","author":[{"name":"Wilson Freitas","url":{}}],"date":"2022-06-18","categories":["R","fixedincome","rb3","opendata"]},"containsRefs":false,"markdown":"\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\n```\n\n```{r load-packages}\nlibrary(rb3)\nlibrary(bizdays)\nlibrary(dplyr)\nlibrary(fixedincome)\nlibrary(ggplot2)\n```\n\n```{r load-data, echo=FALSE, cache=TRUE}\ncache_folder <- \"C:\\\\Users\\\\wilso\\\\R\\\\rb3-cache\"\ndf <- futures_mget(\n  first_date = \"2007-01-01\",\n  last_date = preceding(Sys.Date() - 1, \"Brazil/ANBIMA\"),\n  cache_folder = cache_folder\n)\n```\n\nO pacote {rb3} faz extrações de dados do site da B3.\nTemos diversas informações disponíveis no site inclusive o histórico de diversos dados.\n\nUm conjunto de dados que mais utilizo são os preços de ajuste dos contratos futuros.\nEste histórico é um dos mais antigos disponível.\n\nVou baixar todo o histórico de contratos futuros desde 2007.\nA partir dos preços de ajuste é possível construir o histórico de curvas prefixadas.\nDepois vou fazer uma segmentação pelo ano da data de referência para que seja possível\nvisualizar, para cada ano, todo o espectro de curvas no ano.\n\nVou começar baixando todos os dados desde 2007 até a última data disponível.\nPara isso vou utilizar a função `rb3::futures_mget`.\n*Isso leva um bom tempo!*\n\n```{r eval=FALSE}\ndf <- futures_mget(\n  first_date = \"2007-01-01\",\n  last_date = preceding(Sys.Date() - 1, \"Brazil/ANBIMA\")\n)\n```\n\nÉ necessário filtrar os contratos futuros de DI1 para construir a curva prefixada.\n\n```{r cache=TRUE}\ndf_di1 <- df |> filter(commodity == \"DI1\")\n```\n\nPara construir a curva prefixada é necessário obter as datas de vencimento dos contratos\nfuturos.\nPara isso utilizo a função `rb3::maturity2date` que converte o código de vencimento\nem data.\nAdicionalmente faço o ajuste da data de referência criando a coluna `fixing`,\ncalculo os dias úteis (coluna `business_days`) e a taxa de juros com base no preço de ajuste `price`\ngerando a coluna `adjusted_tax`.\n\n```{r cache=TRUE}\ndf_di1_futures <- df_di1 |>\n  mutate(\n    maturity_date = maturity2date(maturity_code),\n    fixing = following(maturity_date, \"Brazil/ANBIMA\"),\n    business_days = bizdays(refdate, fixing, \"Brazil/ANBIMA\"),\n    adjusted_tax = implied_rate(\"discrete\", business_days / 252, 100000 / price)\n  ) |>\n  filter(business_days > 0)\n```\n\nTermino filtrando as linhas com `business_days` maior que zero, pois não me interessam os futuros\nna data de vencimento.\n\nAgora vamos gerar a visualização com ggplot2.\n\n```{r cache=TRUE, fig.height=8, fig.fig.width=8, preview=TRUE}\ndf_di1_futures |>\n  mutate(year = as.integer(format(refdate, \"%Y\"))) |>\n  ggplot(aes(\n    x = business_days, y = adjusted_tax,\n    group = refdate\n  )) +\n  geom_line(alpha = 0.2) +\n  facet_wrap(. ~ year) +\n  labs(\n    x = \"Dias Úteis\", y = \"Taxas\",\n    title = \"16 anos de Curva Prefixada\",\n    subtitle = \"Curvas construídas a partir dos preços de ajuste dos contratos Futuros DI1\",\n    caption = \"Fonte: B3 (obtidos com \\U1F4E6 rb3) - wilsonfreitas\"\n  ) +\n  scale_y_continuous(labels = scales::percent)\n```\n\nCurioso ver a mudança de *shape* da curva entre os anos e ao longo de cada ano.\nUma coisa curiosa é observar os anos de 2016, 2017 e 2018.\n2016/2017 foram os anos do impechemant da presidente Dilma.\nEm 2016 a parte curta da curva variou pouco e a parte longa variou muito.\nEm 2017 aconteceu o oposto, a parte curta da curva variou mais que a parte longa da curva.\nNestes anos, as mudanças afetam diretamente o *shape* da curva.\nEm 2018, o ano da eleição e da facada do Bolsonaro, há uma grande variação na parte longa\nda curva, mas sem alterar o *shape* da curva.\nAinda é possível avaliar o comportamento da curva com os demais eventos políticos e econômicos.\nEm 2021, por exemplo, onde ocorreu uma elevação da taxa SELIC e uma piora do cenário fiscal,\ntemos um espectro muita amplo do *shape* da curva.\n\nÉ possível construir uma visualização equivalente utilizando dados da curva americana que podem\nser obtidos com o pacote Quandl.\n\n```{r get-data-fake, eval=FALSE}\nlibrary(Quandl)\n\nyc_all <- Quandl(\"USTREASURY/YIELD\")\n```\n\n```{r quandl-data-load, cache=TRUE, echo=FALSE}\nlibrary(Quandl)\n\nyc_all <- Quandl(\"USTREASURY/YIELD\", api_key = \"nJ1NhTYdEs2p3MsS4CVd\")\n```\n\nOs dados vem no formato *wide* onde cada coluna representa um vértice e cada linha uma curva.\nDessa maneira, faço a conversão dos dados para o formato longo com a função `tidyr::pivot_longer`.\n\n```{r cache=TRUE}\nyc_all <- as_tibble(yc_all)\n\nyc_all_longer <- yc_all |>\n  tidyr::pivot_longer(cols = `1 MO`:`30 YR`)\n\nyc_all_longer\n```\n\nAqui faço o tratamento dos dados para converter os prazos em números, considerando meses de 30\ndias e anos de 360 dias.\n\n```{r cache=TRUE}\nlibrary(stringr)\n\nn <- str_match(yc_all_longer$name, \"\\\\d+\") |> as.numeric()\np <- str_match(yc_all_longer$name, \"(MO|YR)$\")[, 1]\nyc_all_longer$days <- ifelse(p == \"MO\", 30, 360) * n\n\nyc_all_longer\n```\n\nAgora fazemos a visualização.\n\n```{r cache=TRUE, fig.height=8, fig.fig.width=8}\nyc_all_longer |>\n  mutate(\n    year = as.integer(format(Date, \"%Y\")),\n    value = value / 100\n  ) |>\n  filter(year >= 2007) |>\n  ggplot(aes(\n    x = days, y = value,\n    group = Date\n  )) +\n  geom_line(alpha = 0.2) +\n  facet_wrap(. ~ year) +\n  labs(\n    x = \"Dias Corridos\", y = \"Taxas\",\n    title = \"16 anos de Curva Prefixada Americana\",\n    caption = \"Fonte: US Treasury (obtidos com \\U1F4E6 Quandl) - wilsonfreitas\"\n  ) +\n  scale_y_continuous(labels = scales::percent)\n```\n\nJá na curva americana, a dinâmica é muito mais bem comportada.\nA parte longo costuma oscilar, mas mantendo a dinâmica.\nOs anos 2007, 2008 e 2020, onde tivemos crise do subprime e COVID, trouxeram mais volatilidade."},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"toc":true,"output-file":"16-anos-de-curva-prefixada.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.335","theme":"litera","title-block-banner":true,"title":"16 anos de Curva Prefixada","description":"Observando a dinâmica da estrutura a termo de juros no Brasil e nos Estados\nUnidos ao longo dos últimos 16 anos.\n","author":[{"name":"Wilson Freitas","url":{}}],"date":"2022-06-18","categories":["R","fixedincome","rb3","opendata"]},"extensions":{"book":{"multiFile":true}}}}}