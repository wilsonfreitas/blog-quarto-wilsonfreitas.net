{
  "hash": "aeba5b7678544c2c58c21af17284acc2",
  "result": {
    "markdown": "---\ntitle: \"Expectativas de Mercado da Pesquisa Focus no R\"\ndescription: |\n  Obtendo as expectativas de mercado para os indicadores macroeconômicos da\n  Pesquisa Focus utilizando o R e o pacote {rbcb}.\nauthor: \"Wilson Freitas\"\ndate: \"2022-06-03\"\ncategories: [R, bcb, opendata]\nformat:\n  html:\n    toc: true\n    html-math-method: katex\n---\n\n\n\n\nÉ possível obter as expectativas de mercado para diversos indicadores\nmacroeconômicos da pesquisa Focus de forma totalmente automática utilizando\no R.\n\nVamos utilizar o pacote {rbcb} para obter estes dados.\nO pacote {rbcb} é uma interface para algumas das diversas APIs do portal de dados\nabertos do Banco Central ([link](https://dadosabertos.bcb.gov.br)).\n\n[expectativas-mercado]: https://dadosabertos.bcb.gov.br/dataset/expectativas-mercado\n\nAs expectativas de mercado para os indicadores macroeconômicos da pesquisa\nFocus são consolidadas em estatísticas diárias e divulgadas na\n[API][expectativas-mercado].\nEstas estatísticas são calculadas com base nas expectativas de mercado\nde diversos bancos, gestores de recursos e demais instituições do mercado\nfinanceiro.\nOs indicadores macroeconômicos são referentes a índices de preços, crescimento\ndo PIB e da produção industrial, taxa de câmbio, taxa Selic, variáveis fiscais\ne indicadores do setor externo e são publicadas todo primeiro dia útil da\nsemana.\n\nCarregando os pacotes utilizados.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(rbcb)\n```\n:::\n\n\n# Função `get_market_expectations`\n\nA função `get_market_expectations` implementa a interface para a API de\nexpectativas de mercado da pesquisa Focus.\nVejamos os seus argumentos e o que podemos fazer com eles:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_market_expectations |> args()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nfunction (type = c(\"annual\", \"quarterly\", \"monthly\", \"inflation-12-months\", \n    \"top5s-monthly\", \"top5s-annual\", \"institutions\", \"selic\", \n    \"top5s-selic\"), indic = NULL, start_date = NULL, end_date = NULL, \n    keep_names = TRUE, ...) \nNULL\n```\n:::\n:::\n\n\n* `type`: A API de expectativas possui diversos *endpoints* e o argumento `type`\ndefine qual deve ser utilizado. Se não for informado o valor `annual` será utilizado.\n    * `annual`, `quarterly` e `monthly` retorna, respectivamente, as expectativas anuais, trimestrais e mensais dos indicadores macroeconômicos\n    * `inflation-12-months` para expectativas de inflação nos próximos 12 meses\n    * `top5s-monthly` e `top5s-annual` retorna as expectativas mensais e anuais para os indicadores do Top 5\n    * `institutions` expectativas informadas pelas instituições credenciadas\n    * `selic` expectativas de mercado SELIC\n    * `top5s-selic` expectativas Top 5 para SELIC\n* `indic` nome do indicador macroeconômico, é opcional, de forma, quando não\nfor definido, todos os indicadores disponíveis para o *endpoint* serão\nretornados. Esse ponto é curioso, pois a documentação não é boa e informa\nindicadores que não são mais disponibilizados.\n* `start_date` e `end_date` definem as datas de início e fim para a consulta,\nsão opcionais e caso não sejam informados, todo o período será retornado, o\nque não é recomendado pois onera os serviços de dados do BCB que já não são\nlá os melhores.\n* `keep_names` é um argumento utilizado internamente que não faz diferença para\no usuário final.\n* `...` aqui são passados argumentos adicionais para a API\n    * `$select` define as colunas retornadas na consulta: `Nome, Idade`\n    * `$filter` define filtros mais elaborados baseado nos valores das colunas: `Nome eq 'João'`\n    * `$orderby` define como as colunas devem ser ordenadas: `Nome asc, Idade desc`\n    * `$skip` define quantidade de linhas no começo que não devem ser retornadas\n    * `$top` define a quantidade de linhas que serão retornadas\n\n# Conhecendo os valores retornados\n\nCada *endpoint* possui o seu conjuto de colunas retornadas e isso pode mudar\ncom o tempo, dessa maneira, para conhecer cada API, eu recomendo fortemente\nque a opção `$top = 10` seja utilizada para limitar uma consulta inicial para\nconhecimento dos valores retornados.\n\n\n::: {.cell hash='expectativas-focus-com-rbcb_cache/html/get_market_expectations-annual-IPCA-top-10_b6e56bbc2904eebea4bd6bdbf6b5785f'}\n\n```{.r .cell-code}\nget_market_expectations(\"annual\",\n  indic = \"IPCA\",\n  `$top` = 10\n) |>\n  rmarkdown::paged_table()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Indicador\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"IndicadorDetalhe\"],\"name\":[2],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"Data\"],\"name\":[3],\"type\":[\"date\"],\"align\":[\"right\"]},{\"label\":[\"DataReferencia\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"Media\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Mediana\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"DesvioPadrao\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Minimo\"],\"name\":[8],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"Maximo\"],\"name\":[9],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"numeroRespondentes\"],\"name\":[10],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"baseCalculo\"],\"name\":[11],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-03\",\"4\":\"2000\",\"5\":\"7.00\",\"6\":\"7\",\"7\":\"0.80\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-04\",\"4\":\"2000\",\"5\":\"7.00\",\"6\":\"7\",\"7\":\"0.79\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-05\",\"4\":\"2000\",\"5\":\"6.97\",\"6\":\"7\",\"7\":\"0.76\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-06\",\"4\":\"2000\",\"5\":\"6.91\",\"6\":\"7\",\"7\":\"0.58\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-07\",\"4\":\"2000\",\"5\":\"6.91\",\"6\":\"7\",\"7\":\"0.58\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-10\",\"4\":\"2000\",\"5\":\"6.92\",\"6\":\"7\",\"7\":\"0.56\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-11\",\"4\":\"2000\",\"5\":\"7.15\",\"6\":\"7\",\"7\":\"0.70\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-12\",\"4\":\"2000\",\"5\":\"6.93\",\"6\":\"7\",\"7\":\"0.58\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-13\",\"4\":\"2000\",\"5\":\"6.93\",\"6\":\"7\",\"7\":\"0.58\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2000-01-13\",\"4\":\"2001\",\"5\":\"4.15\",\"6\":\"4\",\"7\":\"0.35\",\"8\":\"NA\",\"9\":\"NA\",\"10\":\"NA\",\"11\":\"0\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nComo vemos, tem muito `NA`.\nTalvez seja por que estamos visualizando dados muito antigos, vamos reordenar\npara trazer os dados mais recentes.\nPara isso é necessário definir a opção `$orderby`.\n\n\n::: {.cell hash='expectativas-focus-com-rbcb_cache/html/get_market_expectations-annual-IPCA-top-10-ordered_878e43b6f770ac25ba71bf5e81cca5ab'}\n\n```{.r .cell-code}\nget_market_expectations(\"annual\",\n  indic = \"IPCA\",\n  `$top` = 10,\n  `$orderby` = \"Data desc\"\n) |>\n  rmarkdown::paged_table()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Indicador\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"IndicadorDetalhe\"],\"name\":[2],\"type\":[\"lgl\"],\"align\":[\"right\"]},{\"label\":[\"Data\"],\"name\":[3],\"type\":[\"date\"],\"align\":[\"right\"]},{\"label\":[\"DataReferencia\"],\"name\":[4],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"Media\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Mediana\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"DesvioPadrao\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Minimo\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Maximo\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"numeroRespondentes\"],\"name\":[10],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"baseCalculo\"],\"name\":[11],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2023\",\"5\":\"5.7644\",\"6\":\"5.7742\",\"7\":\"0.4910\",\"8\":\"3.6387\",\"9\":\"6.9166\",\"10\":\"69\",\"11\":\"1\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2024\",\"5\":\"4.0312\",\"6\":\"4.0000\",\"7\":\"0.5213\",\"8\":\"3.0000\",\"9\":\"5.6500\",\"10\":\"65\",\"11\":\"1\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2025\",\"5\":\"3.7372\",\"6\":\"3.7450\",\"7\":\"0.5158\",\"8\":\"2.9900\",\"9\":\"5.0000\",\"10\":\"54\",\"11\":\"1\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2026\",\"5\":\"3.7387\",\"6\":\"3.7250\",\"7\":\"0.5771\",\"8\":\"3.0000\",\"9\":\"5.0000\",\"10\":\"48\",\"11\":\"1\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2027\",\"5\":\"3.7964\",\"6\":\"3.8000\",\"7\":\"0.5959\",\"8\":\"3.0000\",\"9\":\"5.0000\",\"10\":\"39\",\"11\":\"1\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2023\",\"5\":\"5.7630\",\"6\":\"5.7883\",\"7\":\"0.4401\",\"8\":\"3.6387\",\"9\":\"6.9166\",\"10\":\"142\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2024\",\"5\":\"4.0324\",\"6\":\"4.0000\",\"7\":\"0.5501\",\"8\":\"3.0000\",\"9\":\"5.7557\",\"10\":\"134\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2025\",\"5\":\"3.7515\",\"6\":\"3.6000\",\"7\":\"0.6407\",\"8\":\"2.0000\",\"9\":\"5.5800\",\"10\":\"114\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2026\",\"5\":\"3.7209\",\"6\":\"3.5000\",\"7\":\"0.6916\",\"8\":\"2.0000\",\"9\":\"5.5200\",\"10\":\"106\",\"11\":\"0\"},{\"1\":\"IPCA\",\"2\":\"NA\",\"3\":\"2023-02-10\",\"4\":\"2027\",\"5\":\"3.8021\",\"6\":\"3.6050\",\"7\":\"0.7066\",\"8\":\"3.0000\",\"9\":\"5.5000\",\"10\":\"86\",\"11\":\"0\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nJá ficou melhor, já é possível entender as informações retornadas.\n\n# Realizando uma consulta mais elaborada\n\nPodemos definir melhor a consulta e o que queremos dela:\n\n* retornar as colunas: Data, DataReferencia, Media, Mediana, Maximo, Minimo e DesvioPadrao.\nPara isso vamos utilizar a opção `$select`.\n* filtrar `baseCalculo` igual a 0 e `DataReferencia` igual a 2021 ou 2022 com a opção `$filter`.\n* Com data inicial igual a 2020-12-01, para pegar os dados desde dezembro de 2020\n\n\n::: {.cell hash='expectativas-focus-com-rbcb_cache/html/get_market_expectations-annual-IPCA_2e34fb322d9c4bb5bf50fe7095267d5d'}\n\n```{.r .cell-code}\ndf <- get_market_expectations(\"annual\",\n  indic = \"IPCA\",\n  start_date = \"2020-12-01\",\n  `$filter` = \"(DataReferencia eq '2021' or DataReferencia eq '2022') and baseCalculo eq 0\",\n  `$select` = \"Data,DataReferencia,Media,Mediana,DesvioPadrao,Maximo,Minimo\"\n)\ndf |>\n  head() |>\n  rmarkdown::paged_table()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Data\"],\"name\":[1],\"type\":[\"date\"],\"align\":[\"right\"]},{\"label\":[\"DataReferencia\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"Media\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Mediana\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"DesvioPadrao\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Minimo\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Maximo\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2020-12-01\",\"2\":\"2021\",\"3\":\"3.43\",\"4\":\"3.44\",\"5\":\"0.35\",\"6\":\"2.49\",\"7\":\"4.26\"},{\"1\":\"2020-12-01\",\"2\":\"2022\",\"3\":\"3.40\",\"4\":\"3.50\",\"5\":\"0.29\",\"6\":\"2.60\",\"7\":\"4.50\"},{\"1\":\"2020-12-02\",\"2\":\"2021\",\"3\":\"3.43\",\"4\":\"3.44\",\"5\":\"0.34\",\"6\":\"2.49\",\"7\":\"4.26\"},{\"1\":\"2020-12-02\",\"2\":\"2022\",\"3\":\"3.40\",\"4\":\"3.50\",\"5\":\"0.29\",\"6\":\"2.60\",\"7\":\"4.50\"},{\"1\":\"2020-12-03\",\"2\":\"2021\",\"3\":\"3.41\",\"4\":\"3.41\",\"5\":\"0.34\",\"6\":\"2.49\",\"7\":\"4.26\"},{\"1\":\"2020-12-03\",\"2\":\"2022\",\"3\":\"3.40\",\"4\":\"3.50\",\"5\":\"0.29\",\"6\":\"2.60\",\"7\":\"4.50\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n# Visualizando os dados\n\nCom as estatísticas de expectativas de IPCA carregadas podemos começar a\nvisualização dos dados.\nEstas expectativas são referentes a inflação cheia para os anos de 2021 e 2022\n(DataReferencia).\nO filtro baseCalculo igual a 1 refere-se ao prazo de validade das expectativas\ninformadas.\nEsta coluna pode ser 0 ou 1.\nbaseCalculo igual a 0 considera as expectativas informadas nos últimos 30 dias\nno cálculo das estatísticas e baseCalculo igual a 1 considera os últimos 4 dias.\nFoi escolhida baseCalculo igual a 0 por ter uma amostra maior, consequência do\nperíodo maior.\n\n## Série temporal das expectativas de IPCA\n\nVamos começar observando a série temporal das expectativas para cada\nDataReferencia.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  ggplot(aes(x = Data, y = Mediana, group = DataReferencia, colour = DataReferencia)) +\n  geom_line() +\n  labs(\n    title = \"Expectativas para IPCA em 2021 e 2022\",\n    subtitle = \"Média das expectativas de IPCA\",\n    caption = \"Dados da Pesquisa Focus obtidos com pacote rbcb\",\n    x = \"Data\", y = \"Inflação\"\n  )\n```\n\n::: {.cell-output-display}\n![](expectativas-focus-com-rbcb_files/figure-html/ipca-mediana-datareferencia-1.png){width=672}\n:::\n:::\n\n\nCurioso ver como as expectativas de inflação para 2021 mudaram ao longo de 2021,\nou seja, erra-se miseravelmente.\nAs expectativas para 2022 mudam menos, bem, isso até virar o ano.\n\n## Série temporal com intervalo informado\n\nVamos olhar agora apenas a DataReferencia 2021 e colocar as linhas de máximo e\nmínimo para termos uma ideia de intervalo para as expectativas.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf |>\n  filter(DataReferencia == 2021) |>\n  ggplot(aes(x = Data)) +\n  geom_line(aes(y = Mediana), colour = \"black\") +\n  geom_line(aes(y = Maximo), colour = \"grey\") +\n  geom_line(aes(y = Minimo), colour = \"grey\") +\n  geom_ribbon(aes(ymin = Minimo, ymax = Maximo), fill = \"blue\", alpha = 0.3) +\n  labs(\n    title = \"Expectativas para IPCA em 2021\",\n    subtitle = \"Média das expectativas de IPCA com intervalo definido por máximo e mínimo da amostra\",\n    caption = \"Dados da Pesquisa Focus obtidos com pacote rbcb\",\n    x = \"Data\", y = \"Inflação\"\n  )\n```\n\n::: {.cell-output-display}\n![](expectativas-focus-com-rbcb_files/figure-html/ipca-mediana-desviopadrao-1.png){width=672}\n:::\n:::\n\n\nInteressante ver como as pesquisas erram e como, mesmo os mais ousados, não\nsaem muito do consenso.\nEntendo que esse é um mecanismo necessário para se colocar o \"bode na sala\",\ne\nntretanto, erra-se miseravelmente, são muitos vieses envolvidos.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}